<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astrales Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1E1E1E;
            color: #e0e0e0;
            padding: 20px;
        }
        .debug-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #28a745; color: white; }
        .error { background: #dc3545; color: white; }
        .warning { background: #ffc107; color: black; }
        .info { background: #17a2b8; color: white; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>Astrales Debug Tool</h1>
        
        <div class="status info">
            <h3>Диагностика проблемы загрузки</h3>
            <p>Этот инструмент поможет определить причину зависания экрана загрузки.</p>
        </div>

        <div class="status warning">
            <h3>Быстрое решение</h3>
            <p>Если экран загрузки завис, попробуйте:</p>
            <button onclick="clearLocalStorage()">Очистить кэш</button>
            <button onclick="forceHideLoading()">Принудительно скрыть загрузку</button>
            <button onclick="testFirebase()">Проверить Firebase</button>
        </div>

        <div class="status info">
            <h3>Проверка состояния</h3>
            <button onclick="checkStatus()">Проверить статус</button>
            <button onclick="checkConsole()">Проверить консоль</button>
        </div>

        <div id="statusLog" class="log">
            <div>Готов к диагностике...</div>
        </div>

        <div class="status info">
            <h3>Переход к приложению</h3>
            <button onclick="goToApp()">Открыть Astrales</button>
            <button onclick="goToAppWithReset()">Открыть с сбросом</button>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('statusLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#e0e0e0';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLocalStorage() {
            try {
                localStorage.clear();
                log('Кэш очищен успешно', 'success');
            } catch (error) {
                log('Ошибка при очистке кэша: ' + error.message, 'error');
            }
        }

        function forceHideLoading() {
            try {
                // Попытка скрыть загрузку через localStorage
                localStorage.setItem('forceHideLoading', 'true');
                log('Флаг принудительного скрытия загрузки установлен', 'success');
            } catch (error) {
                log('Ошибка при установке флага: ' + error.message, 'error');
            }
        }

        async function testFirebase() {
            log('Проверка подключения к Firebase...', 'info');
            try {
                // Проверяем доступность Firebase CDN
                const response = await fetch('https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js');
                if (response.ok) {
                    log('Firebase CDN доступен', 'success');
                } else {
                    log('Firebase CDN недоступен', 'error');
                }
            } catch (error) {
                log('Ошибка подключения к Firebase: ' + error.message, 'error');
            }
        }

        function checkStatus() {
            log('Проверка состояния приложения...', 'info');
            
            // Проверяем localStorage
            const savedUser = localStorage.getItem('astralesUser');
            const allUsers = localStorage.getItem('astralesAllUsers');
            
            if (savedUser) {
                log('Найден сохраненный пользователь', 'success');
            } else {
                log('Сохраненный пользователь не найден', 'warning');
            }
            
            if (allUsers) {
                log('Найден кэш пользователей', 'success');
            } else {
                log('Кэш пользователей не найден', 'warning');
            }

            // Проверяем настройки звука
            const soundEnabled = localStorage.getItem('soundEnabled');
            log(`Настройки звука: ${soundEnabled}`, 'info');

            // Проверяем обои чатов
            const chatWallpapers = localStorage.getItem('chatWallpapers');
            if (chatWallpapers) {
                log('Найдены сохраненные обои чатов', 'success');
            } else {
                log('Обои чатов не найдены', 'info');
            }
        }

        function checkConsole() {
            log('Проверка консоли браузера...', 'info');
            log('Откройте консоль разработчика (F12) и проверьте наличие ошибок', 'warning');
            log('Обычные ошибки: Firebase connection, CORS, network issues', 'info');
        }

        function goToApp() {
            window.location.href = 'index.html';
        }

        function goToAppWithReset() {
            clearLocalStorage();
            forceHideLoading();
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }

        // Автоматическая проверка при загрузке
        window.addEventListener('load', () => {
            log('Страница диагностики загружена', 'success');
            checkStatus();
        });
    </script>
</body>
</html>
